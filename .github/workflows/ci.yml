name: CI Build and E2E Test

on:
  push:
    branches: [develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build --no-daemon -x test

      - name: Start services with Docker Compose
        run: docker compose up -d

      - name: Wait for application to start
        run: |
          echo "Waiting for application to start..."
          for i in {1..60}; do
            if curl -s http://localhost:8080/actuator/health > /dev/null; then
              echo "Application is ready!"
              exit 0
            fi
            echo "Waiting... ($i/60)"
            sleep 2
          done
          echo "Application failed to start"
          docker compose logs
          exit 1

      - name: Test signup endpoint
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/auth/signup \
            -H "Content-Type: application/json" \
            -d '{"username":"testuser","email":"test@example.com","password":"testpass123"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ne 201 ]; then
            echo "Signup test failed with status $HTTP_CODE"
            echo "Response body: $BODY"
            docker compose logs backend
            exit 1
          fi

          echo "✅ Signup test passed!"

      - name: Test signin endpoint
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/auth/signin \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com","password":"testpass123"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Signin test failed with status $HTTP_CODE"
            exit 1
          fi

          if ! echo "$BODY" | grep -q "testuser"; then
            echo "Signin response does not contain expected username"
            exit 1
          fi

          # JWT認証: accessTokenが返されることを確認
          if ! echo "$BODY" | grep -q "accessToken"; then
            echo "Signin response does not contain accessToken"
            exit 1
          fi

          # JWT認証: refreshTokenが返されることを確認
          if ! echo "$BODY" | grep -q "refreshToken"; then
            echo "Signin response does not contain refreshToken"
            exit 1
          fi

          echo "✅ Signin test passed!"
          echo "✅ JWT token generation verified!"

      - name: Test validation errors
        run: |
          # 無効なメールアドレスでのサインアップテスト
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/auth/signup \
            -H "Content-Type: application/json" \
            -d '{"username":"testuser2","email":"invalid-email","password":"testpass123"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

          echo "Validation test HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 400 ]; then
            echo "Validation test failed - expected 400 but got $HTTP_CODE"
            exit 1
          fi

          echo "✅ Validation test passed!"

      - name: Test duplicate email
        run: |
          # 重複したメールアドレスでのサインアップテスト
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/auth/signup \
            -H "Content-Type: application/json" \
            -d '{"username":"testuser3","email":"test@example.com","password":"testpass123"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "Duplicate email test HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ne 400 ]; then
            echo "Duplicate email test failed - expected 400 but got $HTTP_CODE"
            exit 1
          fi

          if ! echo "$BODY" | grep -q "このメールアドレスは既に登録されています"; then
            echo "Duplicate email error message not found"
            exit 1
          fi

          echo "✅ Duplicate email test passed!"

      - name: Test wrong password
        run: |
          # 誤ったパスワードでのログインテスト
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/auth/signin \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com","password":"wrongpassword"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "Wrong password test HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ne 400 ]; then
            echo "Wrong password test failed - expected 400 but got $HTTP_CODE"
            exit 1
          fi

          if ! echo "$BODY" | grep -q "メールアドレスまたはパスワードが正しくありません"; then
            echo "Wrong password error message not found"
            exit 1
          fi

          echo "✅ Wrong password test passed!"

      - name: Test admin user creation endpoint
        run: |
          # 管理者キーで新しい管理者アカウントを作成
          ADMIN_KEY="admin-secret-key-change-in-production"
          ADMIN_SIGNUP=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/admin/users \
            -H "Content-Type: application/json" \
            -H "X-Admin-Key: $ADMIN_KEY" \
            -d '{"email":"admin@example.com","username":"adminuser","password":"adminpass123"}')
          HTTP_CODE=$(echo "$ADMIN_SIGNUP" | tail -n 1)
          BODY=$(echo "$ADMIN_SIGNUP" | head -n -1)

          echo "Admin user creation HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ne 201 ]; then
            echo "Admin user creation failed with status $HTTP_CODE"
            docker compose logs backend | tail -50
            exit 1
          fi

          if ! echo "$BODY" | grep -q "ROLE_ADMIN"; then
            echo "Admin user role not verified in response"
            exit 1
          fi

          echo "✅ Admin user created successfully!"

          # 無効な管理キーでテスト（401エラー期待）
          INVALID_KEY=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/admin/users \
            -H "Content-Type: application/json" \
            -H "X-Admin-Key: invalid-key" \
            -d '{"email":"invalid@example.com","username":"invaliduser","password":"pass123"}')
          HTTP_CODE=$(echo "$INVALID_KEY" | tail -n 1)

          echo "Invalid admin key HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 401 ]; then
            echo "Expected 401 Unauthorized for invalid key but got $HTTP_CODE"
            exit 1
          fi

          echo "✅ Invalid admin key rejected!"

          # 管理キーなしでテスト（401エラー期待）
          NO_KEY=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/admin/users \
            -H "Content-Type: application/json" \
            -d '{"email":"nokey@example.com","username":"nokeyuser","password":"pass123"}')
          HTTP_CODE=$(echo "$NO_KEY" | tail -n 1)

          echo "No admin key HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 401 ] && [ "$HTTP_CODE" -ne 403 ]; then
            echo "Expected 401/403 for missing key but got $HTTP_CODE"
            exit 1
          fi

          echo "✅ Missing admin key rejected!"

      - name: Test admin user can create subjects
        run: |
          # 管理者でサインイン
          ADMIN_SIGNIN=$(curl -s -X POST http://localhost:8080/api/auth/signin \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@example.com","password":"adminpass123"}')
          ADMIN_TOKEN=$(echo "$ADMIN_SIGNIN" | grep -o '"accessToken":"[^"]*"' | cut -d'"' -f4)
          echo "Obtained admin JWT token"

          if [ -z "$ADMIN_TOKEN" ]; then
            echo "Failed to obtain admin token"
            docker compose logs backend | tail -50
            exit 1
          fi

          # 管理者権限で題材作成（成功期待）
          CREATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/subjects \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ADMIN_TOKEN" \
            -d '{"subjectId":99,"title":"Admin Created Subject","description":"By admin user","maxSections":50}')
          HTTP_CODE=$(echo "$CREATE_RESPONSE" | tail -n 1)
          BODY=$(echo "$CREATE_RESPONSE" | head -n -1)

          echo "Create subject with ROLE_ADMIN HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ne 201 ]; then
            echo "Admin subject creation failed with status $HTTP_CODE"
            docker compose logs backend | tail -50
            exit 1
          fi

          echo "✅ Admin can create subjects!"

      - name: Test admin user management (list, get, update, delete)
        run: |
          # 管理者でサインイン
          ADMIN_SIGNIN=$(curl -s -X POST http://localhost:8080/api/auth/signin \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@example.com","password":"adminpass123"}')
          ADMIN_TOKEN=$(echo "$ADMIN_SIGNIN" | grep -o '"accessToken":"[^"]*"' | cut -d'"' -f4)
          ADMIN_ID=$(echo "$ADMIN_SIGNIN" | grep -o '"userId":"[^"]*"' | cut -d'"' -f4)
          echo "Admin token obtained: $ADMIN_TOKEN"
          echo "Admin ID: $ADMIN_ID"

          # 管理者一覧取得テスト
          LIST_RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/api/admin/users \
            -H "Authorization: Bearer $ADMIN_TOKEN")
          HTTP_CODE=$(echo "$LIST_RESPONSE" | tail -n 1)
          BODY=$(echo "$LIST_RESPONSE" | head -n -1)

          echo "Admin users list HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Admin users list failed with status $HTTP_CODE"
            exit 1
          fi

          if ! echo "$BODY" | grep -q "adminuser"; then
            echo "Admin user not found in list"
            exit 1
          fi

          echo "✅ Admin users list test passed!"

          # 管理者詳細取得テスト
          GET_RESPONSE=$(curl -s -w "\n%{http_code}" "http://localhost:8080/api/admin/users/$ADMIN_ID" \
            -H "Authorization: Bearer $ADMIN_TOKEN")
          HTTP_CODE=$(echo "$GET_RESPONSE" | tail -n 1)
          BODY=$(echo "$GET_RESPONSE" | head -n -1)

          echo "Admin user detail HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Admin user detail failed with status $HTTP_CODE"
            exit 1
          fi

          if ! echo "$BODY" | grep -q "adminuser"; then
            echo "Admin username not found in detail response"
            exit 1
          fi

          echo "✅ Admin user detail test passed!"

          # 管理者ユーザー更新テスト
          UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT "http://localhost:8080/api/admin/users/$ADMIN_ID" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ADMIN_TOKEN" \
            -d '{"username":"updatedadmin","email":"updated@example.com"}')
          HTTP_CODE=$(echo "$UPDATE_RESPONSE" | tail -n 1)
          BODY=$(echo "$UPDATE_RESPONSE" | head -n -1)

          echo "Admin user update HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Admin user update failed with status $HTTP_CODE"
            exit 1
          fi

          if ! echo "$BODY" | grep -q "updatedadmin"; then
            echo "Updated username not found in response"
            exit 1
          fi

          echo "✅ Admin user update test passed!"

          # 新しい管理者を作成して削除テスト
          ADMIN_KEY="admin-secret-key-change-in-production"
          DELETE_ADMIN=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/admin/users \
            -H "Content-Type: application/json" \
            -H "X-Admin-Key: $ADMIN_KEY" \
            -d '{"email":"delete@example.com","username":"deleteadmin","password":"pass123"}')
          DELETE_ADMIN_ID=$(echo "$DELETE_ADMIN" | grep -o '"userId":"[^"]*"' | cut -d'"' -f4)
          echo "Admin user to delete ID: $DELETE_ADMIN_ID"

          # 削除テスト
          DELETE_RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE "http://localhost:8080/api/admin/users/$DELETE_ADMIN_ID" \
            -H "Authorization: Bearer $ADMIN_TOKEN")
          HTTP_CODE=$(echo "$DELETE_RESPONSE" | tail -n 1)

          echo "Admin user delete HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 204 ]; then
            echo "Admin user delete failed with status $HTTP_CODE"
            exit 1
          fi

          # 削除したユーザーを取得しようとする（404期待）
          GET_DELETED=$(curl -s -w "\n%{http_code}" "http://localhost:8080/api/admin/users/$DELETE_ADMIN_ID" \
            -H "Authorization: Bearer $ADMIN_TOKEN")
          HTTP_CODE=$(echo "$GET_DELETED" | tail -n 1)

          if [ "$HTTP_CODE" -ne 404 ]; then
            echo "Expected 404 for deleted user but got $HTTP_CODE"
            exit 1
          fi

          echo "✅ Admin user delete test passed!"
          echo "✅ All admin user management tests passed!"

      - name: Test subjects API
        run: |
          # サインインしてJWTトークンを取得
          SIGNIN_RESPONSE=$(curl -s -X POST http://localhost:8080/api/auth/signin \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com","password":"testpass123"}')
          TOKEN=$(echo "$SIGNIN_RESPONSE" | grep -o '"accessToken":"[^"]*"' | cut -d'"' -f4)
          echo "Obtained JWT token"

          # 題材一覧取得テスト（認証不要）
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/api/subjects)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "Subjects API HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Subjects API test failed with status $HTTP_CODE"
            exit 1
          fi

          # デフォルト題材が存在するか確認
          if ! echo "$BODY" | grep -q "デフォルト題材"; then
            echo "Default subject not found in response"
            exit 1
          fi

          # JWT認証: 認証なしで題材作成を試みる（403エラー期待）
          CREATE_RESPONSE_NO_AUTH=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/subjects \
            -H "Content-Type: application/json" \
            -d '{"subjectId":99,"title":"認証なし","description":"失敗するはず","maxSections":50}')
          HTTP_CODE=$(echo "$CREATE_RESPONSE_NO_AUTH" | tail -n 1)

          echo "Create subject without auth HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 403 ]; then
            echo "Expected 403 Forbidden but got $HTTP_CODE"
            exit 1
          fi

          echo "✅ Authentication required for subject creation verified!"

          # RBAC: 一般ユーザー（ROLE_USER）では題材作成できないことを確認（403エラー期待）
          CREATE_RESPONSE_USER=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/subjects \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d '{"subjectId":99,"title":"一般ユーザー","description":"失敗するはず","maxSections":50}')
          HTTP_CODE=$(echo "$CREATE_RESPONSE_USER" | tail -n 1)
          BODY=$(echo "$CREATE_RESPONSE_USER" | head -n -1)

          echo "Create subject with ROLE_USER HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -eq 500 ]; then
            echo "❌ Server error occurred - checking logs..."
            docker compose logs backend | tail -100
            exit 1
          fi

          if [ "$HTTP_CODE" -ne 403 ]; then
            echo "Expected 403 Forbidden for ROLE_USER but got $HTTP_CODE"
            exit 1
          fi

          echo "✅ RBAC verified: ROLE_USER cannot create subjects!"

          # 既存の題材を取得（GET操作は誰でも可能）
          # 既存の題材を取得（GET操作は誰でも可能）
          GET_RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/api/subjects/1)
          HTTP_CODE=$(echo "$GET_RESPONSE" | tail -n 1)
          BODY=$(echo "$GET_RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Get subject test failed with status $HTTP_CODE"
            exit 1
          fi

          if ! echo "$BODY" | grep -q "デフォルト題材"; then
            echo "Default subject not found"
            exit 1
          fi

          echo "✅ Subjects API test passed!"
          echo "✅ JWT authentication for subject operations verified!"
          echo "✅ RBAC verified: Only ROLE_ADMIN can create/update/delete subjects!"

      - name: Test sections API
        run: |
          # デフォルト題材(ID=1)のセクション一覧取得テスト
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/api/subjects/1/sections)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "Sections API HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Sections API test failed with status $HTTP_CODE"
            exit 1
          fi

          echo "✅ Sections API test passed!"

      - name: Test progress management
        run: |
          # 新しいユーザーを作成
          SIGNUP_RESPONSE=$(curl -s -X POST http://localhost:8080/api/auth/signup \
            -H "Content-Type: application/json" \
            -d '{"username":"progressuser","email":"progress@example.com","password":"password123"}')

          USER_ID=$(echo "$SIGNUP_RESPONSE" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
          echo "Created user with ID: $USER_ID"

          if [ -z "$USER_ID" ]; then
            echo "Failed to extract user ID"
            exit 1
          fi

          # サインインしてJWTトークンを取得
          SIGNIN_RESPONSE=$(curl -s -X POST http://localhost:8080/api/auth/signin \
            -H "Content-Type: application/json" \
            -d '{"email":"progress@example.com","password":"password123"}')
          TOKEN=$(echo "$SIGNIN_RESPONSE" | grep -o '"accessToken":"[^"]*"' | cut -d'"' -f4)
          echo "Obtained JWT token for progress user"

          # JWT認証: 認証なしで進捗取得を試みる（403エラー期待）
          PROGRESS_NO_AUTH=$(curl -s -w "\n%{http_code}" http://localhost:8080/api/progress/subjects/1)
          HTTP_CODE=$(echo "$PROGRESS_NO_AUTH" | tail -n 1)

          echo "Progress API without auth HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 403 ]; then
            echo "Expected 403 Forbidden but got $HTTP_CODE"
            exit 1
          fi

          echo "✅ Authentication required for progress API verified!"

          # JWT認証: 認証付きで初期進捗状態を取得（題材ID=1のデフォルト題材）
          PROGRESS_RESPONSE=$(curl -s http://localhost:8080/api/progress/subjects/1 \
            -H "Authorization: Bearer $TOKEN")
          echo "Initial progress: $PROGRESS_RESPONSE"

          if ! echo "$PROGRESS_RESPONSE" | grep -q '"clearedCount":0'; then
            echo "Initial progress should have 0 cleared sections"
            exit 1
          fi

          if ! echo "$PROGRESS_RESPONSE" | grep -q '"subjectId":1'; then
            echo "Progress response should contain subjectId"
            exit 1
          fi

          # JWT認証: 認証なしでセクション完了マークを試みる（403エラー期待）
          MARK_NO_AUTH=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/progress/subjects/1/sections \
            -H "Content-Type: application/json" \
            -d '{"sectionId":0}')
          HTTP_CODE=$(echo "$MARK_NO_AUTH" | tail -n 1)

          if [ "$HTTP_CODE" -ne 403 ]; then
            echo "Expected 403 Forbidden for marking section without auth but got $HTTP_CODE"
            exit 1
          fi

          echo "✅ Authentication required for section completion verified!"

          # JWT認証: 認証付きでセクション0を完了マーク（題材1のセクション0）
          MARK_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/progress/subjects/1/sections \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d '{"sectionId":0}')
          HTTP_CODE=$(echo "$MARK_RESPONSE" | tail -n 1)

          if [ "$HTTP_CODE" -ne 201 ]; then
            echo "Mark section failed with status $HTTP_CODE"
            exit 1
          fi

          # 進捗状態を再取得
          PROGRESS_AFTER=$(curl -s http://localhost:8080/api/progress/subjects/1 \
            -H "Authorization: Bearer $TOKEN")
          echo "Progress after marking section 0: $PROGRESS_AFTER"

          if ! echo "$PROGRESS_AFTER" | grep -q '"clearedCount":1'; then
            echo "Progress should have 1 cleared section"
            exit 1
          fi

          # 重複マークのテスト（既に完了済みのセクション）
          DUPLICATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/progress/subjects/1/sections \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d '{"sectionId":0}')
          HTTP_CODE=$(echo "$DUPLICATE_RESPONSE" | tail -n 1)

          if [ "$HTTP_CODE" -ne 400 ]; then
            echo "Duplicate mark should return 400 but got $HTTP_CODE"
            exit 1
          fi

          # セクション完了削除テスト
          DELETE_RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE http://localhost:8080/api/progress/subjects/1/sections/0 \
            -H "Authorization: Bearer $TOKEN")
          HTTP_CODE=$(echo "$DELETE_RESPONSE" | tail -n 1)

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Delete completed section test failed with status $HTTP_CODE"
            exit 1
          fi

          echo "✅ Progress management test passed!"
          echo "✅ JWT authentication for progress API verified!"
          echo "✅ User isolation verified - userId from JWT instead of URL!"

      - name: Test X-Forwarded-For handling
        run: |
          echo "Testing X-Forwarded-For header handling..."
          echo "This test is run BEFORE the rate limiting test to avoid token exhaustion"
          
          # X-Forwarded-Forヘッダーなしのリクエスト（正常動作）
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/api/health)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Request without X-Forwarded-For failed with status $HTTP_CODE"
            echo "Response: $(echo "$RESPONSE" | head -n -1)"
            exit 1
          fi
          
          # X-Forwarded-Forヘッダー付きリクエスト
          # trusted-proxiesが設定されていない場合、このヘッダーは無視される
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "X-Forwarded-For: 1.2.3.4" http://localhost:8080/api/health)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Request with X-Forwarded-For failed with status $HTTP_CODE"
            echo "Response: $(echo "$RESPONSE" | head -n -1)"
            exit 1
          fi
          
          # 偽装されたX-Forwarded-Forでも同じIPとして扱われることを確認
          # 複数回リクエストしても正常動作
          for i in {1..5}; do
            RESPONSE=$(curl -s -w "\n%{http_code}" -H "X-Forwarded-For: 9.9.9.$i" http://localhost:8080/api/health)
            HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
            
            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "Request $i with fake X-Forwarded-For failed with status $HTTP_CODE"
              exit 1
            fi
          done
          
          echo "✅ X-Forwarded-For handling test passed!"
          echo "✅ Untrusted proxy headers are properly ignored!"
          echo "✅ All fake X-Forwarded-For headers were treated as same client IP!"

      - name: Test rate limiting
        run: |
          echo "Testing rate limiting functionality..."
          
          # レート制限の設定を確認（100リクエスト/分）
          # ただし、Bucket4jの実装では連続リクエストで早めに制限がかかる可能性がある
          # より現実的なテスト: 80回リクエストして、その後429が返ることを確認
          
          SUCCESS_COUNT=0
          RATE_LIMITED_COUNT=0
          FIRST_RATE_LIMIT_AT=0
          
          for i in {1..90}; do
            RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/api/health)
            HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            elif [ "$HTTP_CODE" -eq 429 ]; then
              if [ $FIRST_RATE_LIMIT_AT -eq 0 ]; then
                FIRST_RATE_LIMIT_AT=$i
                echo "First rate limit occurred at request #$i"
              fi
              RATE_LIMITED_COUNT=$((RATE_LIMITED_COUNT + 1))
              BODY=$(echo "$RESPONSE" | head -n -1)
              
              # レート制限エラーメッセージの確認（最初の1回だけチェック）
              if [ $RATE_LIMITED_COUNT -eq 1 ]; then
                if ! echo "$BODY" | grep -q "Too Many Requests"; then
                  echo "Rate limit error message not found"
                  echo "Response body: $BODY"
                  exit 1
                fi
                
                # レート制限ヘッダーの確認
                HEADERS=$(curl -s -I http://localhost:8080/api/health 2>/dev/null)
                if ! echo "$HEADERS" | grep -qi "X-RateLimit-Limit"; then
                  echo "X-RateLimit-Limit header not found"
                  echo "Headers: $HEADERS"
                  exit 1
                fi
                echo "✅ Rate limit error message and headers verified!"
              fi
            else
              echo "Unexpected HTTP status: $HTTP_CODE at request #$i"
              exit 1
            fi
          done
          
          echo "Successful requests: $SUCCESS_COUNT"
          echo "Rate limited requests: $RATE_LIMITED_COUNT"
          echo "First rate limit at: request #$FIRST_RATE_LIMIT_AT"
          
          # レート制限が動作していることを確認
          # 少なくとも50回は成功し、いくつかは制限されるはず
          if [ $SUCCESS_COUNT -lt 50 ]; then
            echo "❌ Too few successful requests - only $SUCCESS_COUNT succeeded"
            echo "Rate limiting may be too strict"
            exit 1
          fi
          
          if [ $RATE_LIMITED_COUNT -lt 5 ]; then
            echo "❌ Rate limiting not working properly - only $RATE_LIMITED_COUNT requests were limited"
            echo "Expected at least 5 rate limited requests"
            exit 1
          fi
          
          # 合計リクエスト数の確認
          TOTAL=$((SUCCESS_COUNT + RATE_LIMITED_COUNT))
          echo "Total requests processed: $TOTAL / 90"
          
          if [ $TOTAL -ne 90 ]; then
            echo "❌ Some requests were not processed correctly"
            exit 1
          fi
          
          echo "✅ Rate limiting test passed!"
          echo "✅ Rate limit headers verified!"
          echo "✅ $RATE_LIMITED_COUNT requests were properly rate limited!"
          echo "✅ Rate limiting activated around request #$FIRST_RATE_LIMIT_AT"

      - name: Test rate limit headers
        run: |
          echo "Testing rate limit headers..."
          
          # ヘッダー情報を取得
          HEADERS=$(curl -s -I http://localhost:8080/api/health)
          
          echo "Response headers:"
          echo "$HEADERS"
          
          # X-RateLimit-Limitヘッダーの確認
          if ! echo "$HEADERS" | grep -qi "X-RateLimit-Limit: 100"; then
            echo "X-RateLimit-Limit header not found or incorrect"
            exit 1
          fi
          
          # X-RateLimit-Remainingヘッダーの確認
          if ! echo "$HEADERS" | grep -qi "X-RateLimit-Remaining:"; then
            echo "X-RateLimit-Remaining header not found"
            exit 1
          fi
          
          echo "✅ Rate limit headers test passed!"

      - name: Show logs on failure
        if: failure()
        run: docker compose logs

      - name: Stop services
        if: always()
        run: docker compose down -v

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/*.jar
