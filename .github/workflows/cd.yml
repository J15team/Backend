name: CD Deploy to AWS

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: j15-backend-dev
  ECS_CLUSTER: j15-backend-cluster-dev
  ECS_SERVICE: j15-backend-service-dev
  ECS_TASK_FAMILY: j15-backend-task-dev
  API_GATEWAY_ID: ${{ secrets.API_GATEWAY_ID }}
  VPC_LINK_ID: ${{ secrets.VPC_LINK_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ========== ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ1: ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜ ==========
      - name: Save current state for rollback
        id: save-state
        run: |
          echo "ğŸ“¸ Saving current state for potential rollback..."

          # ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯å®šç¾©ARNã‚’ä¿å­˜
          CURRENT_TASK_DEF=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --query 'services[0].taskDefinition' \
            --output text)
          echo "current_task_def=$CURRENT_TASK_DEF" >> $GITHUB_OUTPUT

          # ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯IPã‚’ä¿å­˜
          CURRENT_TASK_ARN=$(aws ecs list-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service-name ${{ env.ECS_SERVICE }} \
            --query 'taskArns[0]' \
            --output text)

          if [ "$CURRENT_TASK_ARN" != "None" ] && [ -n "$CURRENT_TASK_ARN" ]; then
            CURRENT_IP=$(aws ecs describe-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --tasks $CURRENT_TASK_ARN \
              --query 'tasks[0].attachments[0].details[?name==`privateIPv4Address`].value' \
              --output text)
            echo "current_ip=$CURRENT_IP" >> $GITHUB_OUTPUT
            echo "current_task_arn=$CURRENT_TASK_ARN" >> $GITHUB_OUTPUT
          fi

          # ç¾åœ¨ã®API Gatewayçµ±åˆURIã‚’ä¿å­˜
          CURRENT_INTEGRATION=$(aws apigatewayv2 get-integrations \
            --api-id ${{ env.API_GATEWAY_ID }} \
            --query 'Items[0].IntegrationUri' \
            --output text 2>/dev/null || echo "")
          echo "current_integration=$CURRENT_INTEGRATION" >> $GITHUB_OUTPUT

          echo "âœ… State saved: TaskDef=$CURRENT_TASK_DEF, IP=$CURRENT_IP"

      # ========== ECRã«ãƒ—ãƒƒã‚·ãƒ¥ ==========
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"

      - name: Build application
        run: |
          chmod +x gradlew
          ./gradlew build --no-daemon -x test

      - name: Build and push Docker image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          IMAGE_TAG="${{ github.sha }}"
          FULL_IMAGE="${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:${IMAGE_TAG}"

          docker build --platform linux/amd64 -t $FULL_IMAGE .
          docker push $FULL_IMAGE

          # latestã‚¿ã‚°ã‚‚æ›´æ–°
          docker tag $FULL_IMAGE ${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:latest
          docker push ${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:latest

          echo "image=$FULL_IMAGE" >> $GITHUB_OUTPUT
          echo "âœ… Image pushed: $FULL_IMAGE"

      # ========== ECSã‚¿ã‚¹ã‚¯æ›´æ–° ==========
      - name: Update ECS task definition
        id: update-task
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’å–å¾—
          aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_TASK_FAMILY }} \
            --query 'taskDefinition' > current-task-def.json

          # æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸URIã§æ›´æ–°
          NEW_IMAGE="${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"

          jq --arg IMAGE "$NEW_IMAGE" \
            '.containerDefinitions[0].image = $IMAGE | 
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
            current-task-def.json > new-task-def.json

          # æ–°ã—ã„ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ç™»éŒ²
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "new_task_def=$NEW_TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "âœ… New task definition: $NEW_TASK_DEF_ARN"

      - name: Deploy to ECS
        id: deploy-ecs
        run: |
          # ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.update-task.outputs.new_task_def }} \
            --force-new-deployment

          echo "â³ Waiting for new task to start..."

          # æ–°ã—ã„ã‚¿ã‚¹ã‚¯ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆæœ€å¤§5åˆ†ï¼‰
          for i in {1..30}; do
            TASK_ARN=$(aws ecs list-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --service-name ${{ env.ECS_SERVICE }} \
              --desired-status RUNNING \
              --query 'taskArns[0]' \
              --output text)
            
            if [ "$TASK_ARN" != "None" ] && [ -n "$TASK_ARN" ]; then
              # ã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚’ç¢ºèª
              TASK_STATUS=$(aws ecs describe-tasks \
                --cluster ${{ env.ECS_CLUSTER }} \
                --tasks $TASK_ARN \
                --query 'tasks[0].lastStatus' \
                --output text)
              
              if [ "$TASK_STATUS" == "RUNNING" ]; then
                # æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã®IPã‚’å–å¾—
                NEW_IP=$(aws ecs describe-tasks \
                  --cluster ${{ env.ECS_CLUSTER }} \
                  --tasks $TASK_ARN \
                  --query 'tasks[0].attachments[0].details[?name==`privateIPv4Address`].value' \
                  --output text)
                
                if [ -n "$NEW_IP" ] && [ "$NEW_IP" != "None" ]; then
                  echo "new_ip=$NEW_IP" >> $GITHUB_OUTPUT
                  echo "new_task_arn=$TASK_ARN" >> $GITHUB_OUTPUT
                  echo "âœ… New task running with IP: $NEW_IP"
                  exit 0
                fi
              fi
            fi
            
            echo "Waiting for task... ($i/30)"
            sleep 10
          done

          echo "âŒ Timeout waiting for new task"
          exit 1

      # ========== API Gatewayæ›´æ–° ==========
      - name: Update API Gateway integration
        id: update-apigw
        run: |
          NEW_IP="${{ steps.deploy-ecs.outputs.new_ip }}"

          # çµ±åˆIDã‚’å–å¾—
          INTEGRATION_ID=$(aws apigatewayv2 get-integrations \
            --api-id ${{ env.API_GATEWAY_ID }} \
            --query 'Items[0].IntegrationId' \
            --output text)

          # çµ±åˆURIã‚’æ›´æ–°
          aws apigatewayv2 update-integration \
            --api-id ${{ env.API_GATEWAY_ID }} \
            --integration-id $INTEGRATION_ID \
            --integration-uri "http://${NEW_IP}:8080/{proxy}"

          echo "integration_id=$INTEGRATION_ID" >> $GITHUB_OUTPUT
          echo "âœ… API Gateway updated to point to $NEW_IP"

      # ========== ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ ==========
      - name: Health check
        id: health-check
        run: |
          # API Gatewayã®URLã‚’å–å¾—
          API_URL=$(aws apigatewayv2 get-api \
            --api-id ${{ env.API_GATEWAY_ID }} \
            --query 'ApiEndpoint' \
            --output text)

          echo "ğŸ” Running health check on $API_URL"

          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
          sleep 30

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§10å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
          for i in {1..10}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/actuator/health" --max-time 10 || echo "000")
            
            if [ "$HTTP_CODE" == "200" ]; then
              echo "âœ… Health check passed!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "Health check attempt $i/10 - HTTP $HTTP_CODE"
            sleep 15
          done

          echo "âŒ Health check failed"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      # ========== ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ï¼‰ ==========
      - name: Rollback on failure
        if: failure() && steps.save-state.outputs.current_task_def != ''
        run: |
          echo "ğŸ”„ Rolling back to previous state..."

          PREV_TASK_DEF="${{ steps.save-state.outputs.current_task_def }}"
          PREV_IP="${{ steps.save-state.outputs.current_ip }}"

          # ECSã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã«æˆ»ã™
          if [ -n "$PREV_TASK_DEF" ] && [ "$PREV_TASK_DEF" != "None" ]; then
            echo "Rolling back ECS to: $PREV_TASK_DEF"
            aws ecs update-service \
              --cluster ${{ env.ECS_CLUSTER }} \
              --service ${{ env.ECS_SERVICE }} \
              --task-definition $PREV_TASK_DEF \
              --force-new-deployment
          fi

          # API Gatewayã‚’å‰ã®IPã«æˆ»ã™
          if [ -n "$PREV_IP" ] && [ "$PREV_IP" != "None" ]; then
            INTEGRATION_ID=$(aws apigatewayv2 get-integrations \
              --api-id ${{ env.API_GATEWAY_ID }} \
              --query 'Items[0].IntegrationId' \
              --output text)
            
            echo "Rolling back API Gateway to IP: $PREV_IP"
            aws apigatewayv2 update-integration \
              --api-id ${{ env.API_GATEWAY_ID }} \
              --integration-id $INTEGRATION_ID \
              --integration-uri "http://${PREV_IP}:8080/{proxy}"
          fi

          echo "âœ… Rollback completed"

      # ========== å®Œäº†é€šçŸ¥ ==========
      - name: Deployment summary
        if: success()
        run: |
          API_URL=$(aws apigatewayv2 get-api \
            --api-id ${{ env.API_GATEWAY_ID }} \
            --query 'ApiEndpoint' \
            --output text)

          echo "ğŸ‰ Deployment successful!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Image: ${{ steps.build-image.outputs.image }}"
          echo "ğŸ”§ Task Definition: ${{ steps.update-task.outputs.new_task_def }}"
          echo "ğŸŒ API URL: $API_URL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
